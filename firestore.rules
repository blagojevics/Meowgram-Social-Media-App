rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------- USERS ----------------
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null;

      // User can update their own profile fields
      allow update: if request.auth != null && request.auth.uid == userId;

      // Allow others to update counts only
      allow update: if request.auth != null &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['followersCount', 'followingCount', 'postsCount']);

      allow delete: if false;

      // Followers subcollection
      match /followers/{followerId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.auth.uid == followerId;
        allow delete: if request.auth != null && request.auth.uid == followerId;
      }

      // Following subcollection
      match /following/{followingId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.auth.uid == userId;
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ---------------- POSTS ----------------
    match /posts/{postId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null;

      // Post owner can update anything (except likes - they shouldn't like their own posts)
      allow update: if request.auth != null && request.auth.uid == resource.data.userId
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['likedByUsers', 'likesCount']);

      // SECURE LIKE FUNCTIONALITY
      // Allow adding a like (user not in current likedByUsers, gets added)
      allow update: if request.auth != null
        && request.auth.uid != resource.data.userId  // Can't like own posts
        && !(request.auth.uid in resource.data.likedByUsers)  // User hasn't liked yet
        && (request.auth.uid in request.resource.data.likedByUsers)  // User is being added
        && request.resource.data.likedByUsers.size() == resource.data.likedByUsers.size() + 1  // Only 1 user added
        && request.resource.data.likesCount == resource.data.likesCount + 1  // Count increased by 1
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likedByUsers', 'likesCount']);

      // Allow removing a like (user in current likedByUsers, gets removed)
      allow update: if request.auth != null
        && (request.auth.uid in resource.data.likedByUsers)  // User has liked
        && !(request.auth.uid in request.resource.data.likedByUsers)  // User is being removed
        && request.resource.data.likedByUsers.size() == resource.data.likedByUsers.size() - 1  // Only 1 user removed
        && request.resource.data.likesCount == resource.data.likesCount - 1  // Count decreased by 1
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likedByUsers', 'likesCount']);

      // Allow updating comments count (for when comments are added/removed)
      allow update: if request.auth != null
        && request.resource.data.commentsCount is int
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentsCount']);

      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // ---------------- COMMENTS ----------------
    match /comments/{commentId} {
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      allow read: if request.auth != null;

      // Author can delete their own comment
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;

      // Post owner can delete any comment under their post
      allow delete: if request.auth != null &&
        request.auth.uid == get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.userId;
    }

    // ---------------- NOTIFICATIONS ----------------
    match /notifications/{notificationId} {
      // Only sender can create
      allow create: if request.auth != null && request.resource.data.fromUserId == request.auth.uid;

      // Only recipient can read
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;

      // Only recipient can update (mark as read)
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
    }
  }
}